name: Restream via Ngrok (HLS)

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg unzip wget python3

      - name: Install ngrok
        run: |
          wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip
          sudo mv ngrok /usr/local/bin
          ngrok authtoken ${{ secrets.NGROK_TOKEN }}

      - name: Start HLS restream
        run: |
          mkdir -p hls
          # ffmpeg ÙŠØ´ØºÙ„ Ø§Ù„Ù…ØµØ¯Ø± Ø·ÙˆÙ„ Ù…Ø§ Ø§Ù„Ù€ workflow Ø´ØºØ§Ù„
          ffmpeg -re -i "http://cyberfamily.sytes.net/live/hussein727/hussein/351.ts" \
            -c copy -f hls -hls_time 4 -hls_list_size 10 -hls_flags delete_segments hls/stream.m3u8 > ffmpeg.log 2>&1 &

          # Ø³ÙŠØ±ÙØ± Ù…Ø­Ù„ÙŠ Ø¨Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ†
          nohup python3 -m http.server 8080 --directory hls > server.log 2>&1 &

          # ngrok Ø¹Ù„Ù‰ Ø¨ÙˆØ±Øª 8080
          ngrok http 8080 --log=stdout > ngrok.log &
          sleep 10
          cat ngrok.log | grep -o "https://[0-9a-z]*\.ngrok-free.app" > public_url.txt

      - name: Show public HLS link
        run: |
          url=$(cat public_url.txt)
          echo "ğŸ”— HLS Playlist: $url/stream.m3u8"

      - name: Keep alive
        run: |
          echo "Workflow running... (Ctrl+C Ù„Ø¥ÙŠÙ‚Ø§ÙÙ‡ Ù…Ù† GitHub Actions)"
          sleep 21600 # 6 Ø³Ø§Ø¹Ø§Øª
