name: HLS Stream with Cloudflare

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y ffmpeg python3 unzip

      - name: Download cloudflared
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Prepare HLS folder
        run: mkdir -p hls

      - name: Run FFmpeg (TS ➝ HLS)
        run: |
          ffmpeg -i "http://cyberfamily.sytes.net/live/hussein727/hussein/351.ts" \
            -c:v copy -c:a copy \
            -f hls -hls_time 5 -hls_list_size 6 -hls_flags delete_segments \
            hls/stream.m3u8 > ffmpeg.log 2>&1 &

      - name: Run Python HTTP server in hls folder
        run: |
          cd hls && python3 -m http.server 8080 > ../server.log 2>&1 &

      - name: Run Cloudflare Tunnel
        run: |
          cloudflared tunnel --url http://localhost:8080 > cf.log 2>&1 &
          sleep 5
          grep -o "https://.*trycloudflare.com" cf.log | head -n 1 > public_url.txt

      - name: Show public URL
        run: |
          echo "🔗 HLS Playlist: $(cat public_url.txt)/stream.m3u8"

      - name: Keep workflow alive
        run: |
          echo "Workflow will stay alive for 6 hours..."
          sleep 21600
